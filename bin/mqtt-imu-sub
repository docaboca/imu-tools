#!/usr/bin/env python3
import json
import time

import config as MQTT_CONFIG
import paho.mqtt.client as mqtt


# The callback for when the client receives a CONNACK response from the server.
def on_connect(client, userdata, _flags, rc):
    print(f"Connected to {userdata} with result code {rc}")
    client.subscribe("imu")


start_time, sample_count = time.time(), 0
show_samples = False
show_frame_rate = True

# The callback for when a PUBLISH message is received from the server.


def on_message(_client, _userdata, msg):
    global start_time, sample_count
    data = json.loads(msg.payload)
    if show_samples:
        print(data)
    if "accelerometer" in data:
        now = time.time()
        elapsed = now - start_time
        sample_count += 1
        if elapsed > 1:
            if show_frame_rate:
                # logger.info("{:0.1f} samples/sec", samples / elapsed)
                print(f"{sample_count} samples/sec")
            start_time, sample_count = now, 0


client = mqtt.Client(userdata="client")
client.on_connect = on_connect
client.on_message = on_message
client.on_log = True

if MQTT_CONFIG.user:
    client.username_pw_set(MQTT_CONFIG.user, password=MQTT_CONFIG.password)
print("Connecting to", MQTT_CONFIG.host, end="...")
client.connect(MQTT_CONFIG.host, MQTT_CONFIG.port)

client.loop_forever()
